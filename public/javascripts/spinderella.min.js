Array.prototype.remove=function(a,b){b=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,b)};var Spinderella=function(a,b,c,d,e){this.host=a;this.port=b||42340;this.channels=c||[];this.identifier=d;this.buffer="";this.onMessage=e||function(){}};Spinderella.Util={loadJS:function(a,b){var c=document.createElement("script");c.type="text/javascript";c.src=a;c.onload=b;document.getElementsByTagName("head")[0].appendChild(c)}};
Spinderella.prototype={processConnection:function(){this.channels&&this.channels.length>0&&this.subscribe(this.channels);this.identifier&&this.identify(this.identifier)},processDisconnection:function(){},receiveData:function(a){this.buffer+=a;if(this.buffer.indexOf("\r\n")>=0){a=this.buffer.split("\r\n");this.buffer=a.pop()||"";for(var b=0;b<a.length;b++)this.receiveMessage(a[b])}},receiveMessage:function(a){if((a=JSON.parse(a))&&a.action)this.handleAction(a.action,a.data||{})},handleAction:function(a,
b){switch(a){case "ping":this.performAction("pong");break;case "receive_message":this.onMessage(b.message,b.type,b);break}},performAction:function(a,b){b||(b={});this.socket.send(JSON.stringify({action:a,data:b})+"\r\n")},subscribe:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.channels.indexOf(c)<0&&this.channels.push(c)}this.performAction("subscribe",{channels:a})},unsubscribe:function(a){for(var b=0;b<a.length;b++){var c=this.channels.indexOf(a[b]);c>=0&&this.channels.remove(c)}this.performAction("unsubscribe",
{channels:a})},identify:function(a){this.performAction("identify",{identifier:a})}};Spinderella.Silenced=function(){this.client=new Spinderella;this.client.socket=this};Spinderella.Silenced.isUseable=function(){return true};Spinderella.Silenced.implementationName="Silenced";Spinderella.Silenced.prototype={onMessage:function(){},connect:function(){},onDisconnect:function(){},send:function(){}};Spinderella.Orbited=function(a,b,c,d,e){this.client=new Spinderella(a,b,c,d,e);this.client.socket=this};
Spinderella.Orbited.isUseable=function(){return Spinderella.Orbited.javascriptURL!==null};Spinderella.Orbited.javascriptURL=null;Spinderella.Orbited.orbitedHost=null;Spinderella.Orbited.orbitedPort=null;Spinderella.Orbited.implementationName="Orbited";
Spinderella.Orbited.prototype={reconnectOn:function(){return[Orbited.Errors.RemoteConnectionFailed,Orbited.Errors.UserConnectionReset,Orbited.Statuses.ServerClosedConnection]},onMessage:function(a){this.client.onMessage=a},connect:function(a){var b=this,c=this.client,d=function(){if(Spinderella.Orbited.orbitedHost)Orbited.settings.hostname=Spinderella.Orbited.orbitedHost;if(Spinderella.Orbited.orbitedPort)Orbited.settings.port=Spinderella.Orbited.orbitedPort;b.socket=new Orbited.TCPSocket;if(typeof a!=
"function")a=function(){};b.socket.onread=function(e){c.receiveData(e)};b.socket.onopen=function(){c.processConnection();a()};b.socket.onclose=function(e){b.onDisconnect(e)};b.socket.open(c.host,c.port)};typeof Orbited!="undefined"?d():Spinderella.Util.loadJS(Spinderella.Orbited.javascriptURL,d)},onDisconnect:function(a){this.client.processDisconnection();if(this.reconnectOn().indexOf(a)>=0){var b=this;setTimeout(function(){b.connect()},5E3)}},send:function(a){this.socket.send(a)}};
Spinderella.jsSocket=function(a,b,c,d,e){this.client=new Spinderella(a,b,c,d,e);this.client.socket=this};Spinderella.jsSocket.flashURL=null;Spinderella.jsSocket.javascriptURL=null;Spinderella.jsSocket.implementationName="jsSocket";
Spinderella.jsSocket.isUseable=function(){if(Spinderella.jsSocket.flashURL==null||Spinderella.jsSocket.javascriptURL==null)return false;var a=navigator;return a.mimeTypes?a.mimeTypes["application/x-shockwave-flash"]!==undefined:a.plugins?a.plugins["Shockwave Flash"]!==undefined:false};
Spinderella.jsSocket.prototype={connect:function(a){var b=this,c=this.client,d=function(){jsSocket.swf=Spinderella.jsSocket.flashURL;b.socket=new jsSocket({keepalive:false,autoreconnect:true});if(typeof a!="function")a=function(){};b.socket.onData=function(e){c.receiveData(e)};b.socket.onOpen=function(){c.processConnection();a()};b.socket.onClose=function(){c.processDisconnection()};b.socket.onLoaded=function(){b.socket.connect(c.host,c.port)}};typeof jsSocket!="undefined"?Spinderella.Util.loadJS(Spinderella.jsSocket.javascriptURL,
d):d()},send:function(a){this.socket.send(a)},onMessage:function(a){this.client.onMessage=a}};Spinderella.WebSocket=function(a,b,c,d,e){this.client=new Spinderella(a,b,c,d,e);this.resourceURL="ws://"+a;if(b!=80)this.resourceURL+=":"+b;this.resourceURL+="/spinderella";this.client.socket=this};Spinderella.WebSocket.isUseable=function(){return typeof WebSocket!="undefined"};Spinderella.WebSocket.implementationName="WebSocket";
Spinderella.WebSocket.prototype={onMessage:function(a){this.client.onMessage=a},connect:function(a){this.socket=new WebSocket(this.resourceURL);var b=this.client,c=this;if(typeof a!="function")a=function(){};this.socket.onmessage=function(d){b.receiveData(d.data+"\r\n")};this.socket.onopen=function(){b.processConnection();a()};this.socket.onclose=function(){c.onDisconnect()}},onDisconnect:function(){this.client.processDisconnection()},send:function(a){this.socket.send(a)}};
Spinderella.Implementations=[Spinderella.WebSocket,Spinderella.jsSocket,Spinderella.Orbited,Spinderella.Silenced];Spinderella.getPreferredImplementation=function(){for(var a,b=0;b<Spinderella.Implementations.length;b++){a=Spinderella.Implementations[b];if(a.isUseable&&a.isUseable())return a}};
Spinderella.create=function(a,b,c,d,e){var f=Spinderella.getPreferredImplementation();if(typeof b=="number")b=b;else switch(f){case Spinderella.WebSocket:b=b.websocket;break;default:b=b.base;break}return new f(a,b,c,d,e)};
