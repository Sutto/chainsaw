(function(){Orbited={};Orbited.settings={};Orbited.settings.hostname=document.domain;Orbited.settings.port=location.port.length>0?location.port:80;Orbited.settings.protocol=location.protocol.slice(0,-1);Orbited.settings.log=false;Orbited.settings.streaming=true;Orbited.settings.HEARTBEAT_TIMEOUT=6E3;Orbited.settings.POLL_INTERVAL=2E3;Orbited.settings.pageLoggerHeight="200px";Orbited.settings.pageLoggerWidth=null;Orbited.settings.enableFFPrivileges=false;Orbited.singleton={};Orbited.Errors={};Orbited.Errors.ConnectionTimeout=
101;Orbited.Errors.InvalidHandshake=102;Orbited.Errors.UserConnectionReset=103;Orbited.Errors.Unauthorized=106;Orbited.Errors.RemoteConnectionFailed=108;Orbited.Statuses={};Orbited.Statuses.ServerClosedConnection=201;Orbited.Statuses.SocketControlKilled=301;Orbited.util={};Orbited.util.browser=null;if(typeof ActiveXObject!="undefined")Orbited.util.browser="ie";else if(navigator.userAgent.indexOf("WebKit")!=-1||navigator.userAgent.indexOf("Konqueror")!=-1)Orbited.util.browser="webkit";else if(navigator.product==
"Gecko"&&window.find&&!navigator.savePreferences)Orbited.util.browser="firefox";else if(typeof window.addEventStream==="function")Orbited.util.browser="opera";(function(){Orbited.base64={};if(window.btoa&&window.btoa("1")=="MQ=="){Orbited.base64.encode=function(a){return btoa(a)};Orbited.base64.decode=function(a){return atob(a)}}else{Orbited.base64.encode=function(a){var b=[],c=a.length,f=c%3;c=c-f;for(var e=0;e<c;){var d=a.charCodeAt(e++)<<16|a.charCodeAt(e++)<<8|a.charCodeAt(e++);b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>
18&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>12&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>6&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d&63))}switch(f){case 2:d=a.charCodeAt(e++)<<16|a.charCodeAt(e++)<<8;b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>18&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>
12&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>6&63));b.push("=");break;case 1:d=a.charCodeAt(e++)<<16;b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>18&63));b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>>12&63));b.push("=");b.push("=");break}return b.join("")};Orbited.base64.decode=function(a){a=a.split("");for(var b=[],c=a.length,f=0;a[--c]=="=";)++f;for(var e=0;e<c;){var d=
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[e++])<<18;if(e<=c)d|="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[e++])<<12;if(e<=c)d|="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[e++])<<6;if(e<=c)d|="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[e++]);b.push(String.fromCharCode(d>>>16&255));b.push(String.fromCharCode(d>>>8&255));b.push(String.fromCharCode(d&255))}for(;f--;)b.pop();
return b.join("")}}})();Orbited.loggers={};Orbited.Loggers={};Orbited.util.loggingSystem=null;if(window.Log4js)Orbited.util.loggingSystem="log4js";else if(window.console&&console.firebug&&console.firebug!="1.3.0")Orbited.util.loggingSystem="firebug";Orbited.getLogger=function(a){if(!Orbited.loggers[a]){var b=null;switch(Orbited.util.loggingSystem){case "firebug":b=new Orbited.Loggers.FirebugLogger(a);break;case "log4js":b=new Orbited.Loggers.Log4jsLogger(a);break;default:b=new Orbited.Loggers.PageLogger(a);
break}Orbited.loggers[a]=b}return Orbited.loggers[a]};Orbited.Loggers.FirebugLogger=function(a){var b=this;b.name=a;b.enabled=false;var c=function(f){for(var e=[a+":"],d=0;d<f.length;++d)e.push(f[d]);return e};b.log=function(){b.enabled&&console.log.apply(this,c(arguments))};b.debug=function(){b.enabled&&console.debug.apply(this,c(arguments))};b.info=function(){b.enabled&&console.info.apply(this,c(arguments))};b.warn=function(){b.enabled&&console.warn.apply(this,c(arguments))};b.error=function(){b.enabled&&
console.error.apply(this,c(arguments))};b.assert=function(){if(b.enabled){for(var f=[arguments[0],a+":"],e=1;e<arguments.length;++e)f.push(arguments[e]);console.assert.apply(this,f)}};b.trace=function(){b.enabled&&console.trace.apply(this,c(arguments))}};Orbited.singleton.pageLoggerPane=null;Orbited.Loggers.PageLogger=function(a){var b=this;b.enabled=false;b.name=a;var c=function(){if(!Orbited.singleton.pageLoggerPane){var e=document.createElement("div");e.border="1px solid black";if(Orbited.settings.pageLoggerHeight)e.style.height=
Orbited.settings.pageLoggerHeight;if(Orbited.settings.pageLoggerWidth)e.style.height=Orbited.settings.pageLoggerWidth;e.style.overflow="scroll";document.body.appendChild(e);Orbited.singleton.pageLoggerPane=e}},f=function(e){c();var d=document.createElement("div");d.innerHTML=e;Orbited.singleton.pageLoggerPane.appendChild(d);Orbited.singleton.pageLoggerPane.scrollTop=Orbited.singleton.pageLoggerPane.scrollHeight};b.log=function(){if(b.enabled){for(var e=["log",new Date,"debug","<b>"+a+"</b>"],d=0;d<
arguments.length;++d)e.push(arguments[d]);f(e.join(", "))}};b.debug=function(){if(b.enabled){for(var e=[new Date,"debug","<b>"+a+"</b>"],d=0;d<arguments.length;++d)e.push(arguments[d]);f(e.join(", "))}};b.info=function(){if(b.enabled){for(var e=[new Date,"info","<b>"+a+"</b>"],d=0;d<arguments.length;++d)e.push(arguments[d]);f(e.join(", "))}};b.warn=function(){};b.error=function(){};b.assert=function(){};b.trace=function(){}};Orbited.Loggers.Log4jsLogger=function(a){var b=this;for(var c=b.name=a;c.indexOf(".")!=
-1;)c=c.replace(".","_");var f=Log4js.getLogger(c);b.logger=f;f.setLevel(Log4js.Level.OFF);var e=function(d){for(var m=[a+":"],q=0;q<d.length;++q)m.push(d[q]);return m.join(" ")};b.setLevel=function(d){f.setLevel(d)};b.addAppender=function(d){f.addAppender(d)};b.log=function(){f.info(e(arguments))};b.debug=function(){f.debug(e(arguments))};b.info=function(){f.info(e(arguments))};b.warn=function(){f.warn(e(arguments))};b.error=function(){f.error(e(arguments))};b.assert=function(){};b.trace=function(){}};
Orbited.system=Orbited.getLogger("system");Orbited.CometTransports={};Orbited.util.chooseTransport=function(){if(Orbited.settings.streaming==false||Orbited.util.browser=="webkit")return Orbited.CometTransports.LongPoll;var a=[];for(var b in Orbited.CometTransports){var c=Orbited.CometTransports[b];if(typeof c[Orbited.util.browser]=="number"){Orbited.system.log("viable transport: ",b);a.push(c)}}return a[0]};var w=function(){try{return new XMLHttpRequest}catch(a){}try{return new ActiveXObject("MSXML3.XMLHTTP")}catch(b){}try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(c){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(f){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("Could not find XMLHttpRequest or an alternative.");
};Orbited.legacy={};Orbited.CometSession=function(){var a=this;a.readyState=a.READY_STATE_INITIALIZED;a.onopen=function(){};a.onread=function(){};a.onclose=function(){};var b=null,c=null,f=[],e=0,d=null,m=null,q=3E4,h=3E4,i=null,g=0,l=false,j=null,k=function(){var p=s([[++e,"close"]]);if(j)j.contentWindow.sendCloseFrame(b.render(),p);else{d.open("POST",b.render(),!b.isSameDomain(location.href));d.send(p)}};a.open=function(p){a.logger.debug("open");a.readyState=a.READY_STATE_OPENING;b=new Orbited.URL(p);
if(b.isSameDomain(location.href))d=w();else{d=new Orbited.XSDR;if(b.isSamePort(location.href)){j=document.createElement("iframe");j.style.display="block";j.style.width="0";j.style.height="0";j.style.border="0";j.style.margin="0";j.style.padding="0";j.style.overflow="hidden";j.style.visibility="hidden";var u=new Orbited.URL("");u.protocol=Orbited.settings.protocol;u.domain=Orbited.settings.hostname;u.port=Orbited.settings.port;u.path="/static/xsdClose.html";u.hash=document.domain;j.src=u.render();
document.body.appendChild(j)}}if(Orbited.settings.enableFFPrivileges)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(x){}d.open("GET",p,true);d.onreadystatechange=function(){if(d.readyState==4)if(d.status==200){c=d.responseText;a.logger.debug("session key is: ",c);t();if(b.path[b.path.length]!="/")b.path+="/";b.path+=c;m=new (Orbited.util.chooseTransport());m.timeoutResetter=t;m.isSubDomain=b.isSubDomain(location.href);m.onReadFrame=o;m.onclose=n;m.connect(b.render())}else{d=
null;a.readyState=a.READY_STATE_CLOSED;a.onclose(Orbited.Errors.InvalidHandshake)}};d.send(null)};a.send=function(p){a.logger.debug("send",p);if(a.readyState!=a.READY_STATE_OPEN)throw new Error("Invalid readyState");p=Orbited.base64.encode(p);f.push([++e,"data",p]);a.logger.debug("sending ==",l);if(!l){a.logger.debug("starting send");r()}};a.close=function(){switch(a.readyState){case a.READY_STATE_CLOSING:case a.READY_STATE_CLOSED:return;case a.READY_STATE_INITIALIZED:a.readyState=a.READY_STATE_CLOSED;
return;default:break}a.readyState=a.READY_STATE_CLOSING;f.push([++e,"close"]);l||r()};a.reset=function(){a.logger.debug("reset");var p=a.readyState;a.readyState=a.READY_STATE_CLOSED;switch(p){case a.READY_STATE_INITIALIZED:a.onclose(Orbited.Errors.UserConnectionReset);break;case a.READY_STATE_OPENING:d.onreadystatechange=function(){};d.abort();a.onclose(Orbited.Errors.UserConnectionReset);break;case a.READY_STATE_OPEN:a.sendQueue=[];a.sending=false;if(d.readyState<4){d.onreadystatechange=function(){};
d.abort()}v(Orbited.Errors.UserConnectionReset);k();break;case a.READY_STATE_CLOSING:break;case a.READY_STATE_CLOSED:break}};a.cleanup=function(){a.readyState=a.READY_STATE_CLOSED;m.close()};var o=function(p){a.logger.debug("transportOnReadFrame");a.logger.debug("READ FRAME: ",p.id,p.name,p.data?p.data.length:"");isNaN(p.id)||(g=Math.max(g,p.id));a.logger.debug(p);switch(p.name){case "close":a.readyState<a.READY_STATE_CLOSED&&v(Orbited.Statuses.ServerClosedConnection);break;case "data":a.logger.debug("base64 decoding "+
p.data.length+" bytes of data");p=Orbited.base64.decode(p.data);a.logger.debug("decode complete");a.onread(p);break;case "open":if(a.readyState==a.READY_STATE_OPENING){a.readyState=a.READY_STATE_OPEN;a.logger.debug("Call self.onopen()");a.onopen()}break;case "ping":switch(m.name){case "longpoll":break;case "poll":break;default:f.push([++e,"ping",null]);l||r();break}break;case "opt":p=p.data.split(",");switch(p[0]){case "pingTimeout":h=parseInt(p[1])*1E3;break;case "pingInterval":q=parseInt(p[1])*
1E3;break;default:a.logger.warn("unknown opt key",p[0]);break}break}a.logger.debug("resetting timeout from transportOnReadFrame");t()},n=function(){a.logger.debug("transportOnClose");if(a.readyState<a.READY_STATE_CLOSED)try{v(Orbited.Statuses.ServerClosedConnection)}catch(p){}},s=function(p){for(var u=[],x=0;x<p.length;++x)for(var B=p[x],C=0;C<B.length;++C){var D=B[C];if(D==null)D="";C==B.length-1?u.push("0"):u.push("1");u.push(D.toString().length);u.push(",");u.push(D.toString())}return u.join("")},
r=function(p){a.logger.debug("in doSend");if(typeof p=="undefined")p=0;if(p*250>=3E4){v(Orbited.Errors.ConnectionTimeout);l=false}else if(f.length==0){a.logger.debug("sendQueue exhausted");l=false}else{l=true;a.logger.debug("setting sending=true");var u=f.length;b.setQsParameter("ack",g);var x=s(f);a.logger.debug("post",p,x);if(Orbited.settings.enableFFPrivileges)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(B){}d.open("POST",b.render(),true);d.onreadystatechange=
function(){a.logger.debug("doSend onreadystatechange");switch(d.readyState){case 4:if(d.status==200){t();f.splice(0,u);return r()}else window.setTimeout(function(){r(++p)},250);break}};d.send(x)}},v=function(p){a.logger.debug("doClose",p);E();a.readyState=a.READY_STATE_CLOSED;if(m!=null){m.onReadFrame=function(){};m.onclose=function(){};m.close()}a.onclose(p)},t=function(){a.logger.debug("reset Timeout",q+h);E();i=window.setTimeout(F,q+h)},E=function(){window.clearTimeout(i)},F=function(){a.logger.debug("timed out!");
v(Orbited.Errors.ConnectionTimeout)}};Orbited.CometSession.prototype.logger=Orbited.getLogger("Orbited.CometSession");Orbited.CometSession.prototype.READY_STATE_INITIALIZED=1;Orbited.CometSession.prototype.READY_STATE_OPENING=2;Orbited.CometSession.prototype.READY_STATE_OPEN=3;Orbited.CometSession.prototype.READY_STATE_CLOSING=4;Orbited.CometSession.prototype.READY_STATE_CLOSED=5;var A=0,y={};Orbited.test={};Orbited.test.logger=Orbited.getLogger("Orbited.test");Orbited.test.socketcontrol={};Orbited.test.socketcontrol.kill=
function(a){Orbited.test.logger.debug("kill ordered for socket:",a);if(y[a.id]){y[a.id](Orbited.Statuses.SocketControlKilled);Orbited.test.logger.debug("socket killed")}else Orbited.test.logger.debug("socket not found")};Orbited.test.stompdispatcher={};Orbited.test.stompdispatcher.send=function(a,b){Orbited.test.logger.debug("stompdispatcher dispatching "+b+" to "+a);var c=document.createElement("script");c.src="http://"+Orbited.settings.hostname+":"+Orbited.settings.port+"/system/test/stomp?";c.src+=
"msg="+b;c.src+="&dest="+a;document.body.appendChild(c)};Orbited.TCPSocket=function(){var a=this;a.id=++A;if(arguments.length>0)throw new Error("TCPSocket() accepts no arguments");a.readyState=a.READY_STATE_INITIALIZED;a.onopen=function(){};a.onread=function(){};a.onclose=function(){};var b=false,c="",f=null,e=false,d=null,m=null,q=null;a.open=function(k,o,n){if(a.readyState!=a.READY_STATE_INITIALIZED)throw new Error("Invalid readyState");if(k==false)throw new Error("No hostname specified");if(isNaN(o))throw new Error("Invalid port specified");
e=!!n;a.readyState=a.READY_STATE_OPENING;m=k;q=o;f=new Orbited.CometSession;n=new Orbited.URL("/tcp");n.domain=Orbited.settings.hostname;n.port=Orbited.settings.port;n.protocol=Orbited.settings.protocol;n.setQsParameter("nocache",Math.random());f.open(n.render());f.onopen=l;f.onread=i;f.onclose=j;d="initial"};a.close=function(){if(a.readyState!=a.READY_STATE_CLOSED){a.readyState=a.READY_STATE_CLOSED;g(Orbited.Errors.UserConnectionReset)}};a.reset=function(){f&&f.reset()};a.send=function(k){if(a.readyState!=
a.READY_STATE_OPEN)throw new Error("Invalid readyState");e||(k=Orbited.utf8.encode(k));a.logger.debug("SEND: ",k);f.send(k)};var h=function(){var k=Orbited.utf8.decode(c),o=k[0];c=c.slice(k[1]);o.length>0&&window.setTimeout(function(){a.onread(o)},0)},i=function(k){switch(a.readyState){case a.READY_STATE_OPEN:a.logger.debug("READ: ",k);if(e)window.setTimeout(function(){a.onread(k)},0);else{a.logger.debug("start buffer size:",c.length);c+=k;h();a.logger.debug("end buffer size:",c.length)}break;case a.READY_STATE_OPENING:switch(d){case "initial":k=
Orbited.utf8.decode(k)[0];a.logger.debug("initial");a.logger.debug("data",k);a.logger.debug("len",k.length);a.logger.debug("typeof(data)",typeof k);a.logger.debug("data[0] ",k.slice(0,1));a.logger.debug("type ",typeof k.slice(0,1));var o=k.slice(0,1)=="1";a.logger.debug("result",o);if(!o){a.logger.debug("!result");var n=k.slice(1,4);g(parseInt(n))}if(o){a.readyState=a.READY_STATE_OPEN;a.logger.debug("tcpsocket.onopen..");a.onopen();a.logger.debug("did onopen")}break}break}},g=function(k){a.logger.debug("doClose",
k);if(f){if(k==Orbited.Statuses.ServerClosedConnection||k==Orbited.Errors.Unauthorized||k==Orbited.Errors.RemoteConnectionFailed)f.cleanup();else{j=function(){};f.close()}f=null}a.logger.debug("onCloseTriggered",b);if(!b){a.logger.debug("triggerClose timer",k);b=true;window.setTimeout(function(){a.logger.debug("onclose!",k);a.onclose(k)},0)}};y[a.id]=g;var l=function(){var k=m+":"+q+"\n";a.logger.debug("sessionOpen; sending:",k);k=Orbited.utf8.encode(k);a.logger.debug("encoded payload:",k);X=k;f.send(k);
d="initial"},j=function(k){a.logger.debug("sessionOnClose");g(k)}};Orbited.TCPSocket.prototype.toString=function(){return"<Orbited.TCPSocket "+this.id+">"};Orbited.TCPSocket.prototype.logger=Orbited.getLogger("Orbited.TCPSocket");Orbited.TCPSocket.prototype.READY_STATE_INITIALIZED=1;Orbited.TCPSocket.prototype.READY_STATE_OPENING=2;Orbited.TCPSocket.prototype.READY_STATE_OPEN=3;Orbited.TCPSocket.prototype.READY_STATE_CLOSING=4;Orbited.TCPSocket.prototype.READY_STATE_CLOSED=5;Orbited.singleton.XSDR=
{receiveCbs:{},queues:{},iframes:{},id:0,register:function(a,b){var c=++Orbited.singleton.XSDR.id;Orbited.singleton.XSDR.receiveCbs[c]=a;Orbited.singleton.XSDR.queues[c]=b;Orbited.system.debug("id is",c);return c}};Orbited.XSDR=function(){var a=this,b=null,c,f,e,d,m=[],q=Orbited.singleton.XSDR.register(function(j){g(j)},m),h=new Orbited.URL("");h.domain=Orbited.settings.hostname;h.port=Orbited.settings.port;h.path="/static/xsdrBridge.html";h.hash=q.toString();h.protocol=Orbited.settings.protocol;
a.logger.debug("bridgeUrl.hash is",h.hash);a.logger.debug("bridgeUrl.path is",h.path);a.logger.debug("bridgeUrl is",h.render());var i=function(){a.responseText="";a.status=null;a.readyState=0;e=f=c=null;d={}};i();a.onreadystatechange=function(){};a.open=function(j,k,o){a.readyState==4&&i();if(a.readyState!=0)throw new Error("Invalid readyState");if(!o)throw new Error("Only Async XSDR supported");a.logger.debug("open",j,k,o);a.readyState=1;c=k;f=j};a.send=function(j){if(a.readyState!=1)throw new Error("Invalid readyState");
a.logger.debug("send",j);if(b)m.push([f,c,j,d]);else{a.logger.debug("creating iframe");b=document.createElement("iframe");l(b);b.src=h.render();a.logger.debug("set ifr.src to",b.src);document.body.appendChild(b);Orbited.singleton.XSDR.iframes[q]=b}};a.abort=function(){if(a.readyState>0&&a.readyState<4){a.logger.debug("ABORT called");b.src="about:blank";document.body.removeChild(b);b=null;a.readyState=4;a.onreadystatechange()}};a.setRequestHeader=function(j,k){if(a.readyState!=0)throw new Error("Invalid readyState");
d[j]=k};a.getResponseHeader=function(){if(a.readyState<2)throw new Error("Invalid readyState");return responseHeaders[key]};var g=function(j){a.logger.debug("received",j);switch(j[0]){case "initialized":m.push([f,c,e,d]);a.logger.debug("queue is",m);a.logger.debug("Orbited.singleton.XSDR.queues[id] is",Orbited.singleton.XSDR.queues[q]);break;case "readystatechange":e=j[1];a.readyState=e.readyState;a.logger.debug("readystatechange",a.readyState);if(e.status){a.status=e.status;a.logger.debug("status",
e.status)}if(e.responseText){a.responseText+=e.responseText;a.logger.debug("responseText",e.responseText)}a.logger.debug("doing trigger");a.onreadystatechange();a.logger.debug("trigger complete");break}},l=function(j){j.style.display="block";j.style.width="0";j.style.height="0";j.style.border="0";j.style.margin="0";j.style.padding="0";j.style.overflow="hidden";j.style.visibility="hidden"}};if(Orbited.util.browser=="opera"){var z=window.postMessage&&"contentWindow"||"document";(window.postMessage&&
window||document).addEventListener("message",function(a){var b=a.data.split(" "),c=b.shift();if(c=="event"){var f=b.shift(),e=b.join(" ");e=Orbited.JSON.parse(e);Orbited.singleton.XSDR.receiveCbs[f](e)}if(c=="queues"){f=b.shift();b=Orbited.singleton.XSDR.queues[f];if(b.length>0){e=b.shift();Orbited.singleton.XSDR.iframes[f][z].postMessage(Orbited.JSON.stringify(e),a.origin)}}},false)}Orbited.XSDR.prototype.logger=Orbited.getLogger("Orbited.XSDR");Orbited.singleton.XSDRBridgeLogger=Orbited.getLogger("XSDRBridge");
Orbited.CometTransports.XHRStream=function(){var a=this;a.name="xhrstream";var b=null,c=null,f=null,e=0,d=null,m=null,q=50;a.readyState=0;a.onReadFrame=function(){};a.onread=function(r){a.onReadFrame(r)};a.onclose=function(){};a.close=function(){if(a.readyState!=2){if(c!=null&&(c.readyState>1||c.readyState<4)){c.onreadystatechange=function(){};c.abort();c=null}a.readyState=2;window.clearTimeout(d);window.clearTimeout(m);a.onclose()}};a.connect=function(r){if(a.readyState==1)throw new Error("Already Connected");
b=new Orbited.URL(r);if(c==null)c=b.isSameDomain(location.href)?w():new Orbited.XSDR;b.path+="/xhrstream";a.readyState=1;h()};var h=function(){try{typeof f=="number"&&b.setQsParameter("ack",f);if(typeof c=="undefined"||c==null)throw new Error("how did this happen?");if(Orbited.settings.enableFFPrivileges)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(r){}c.open("GET",b.render(),true);c.onreadystatechange=function(){a.logger.debug(c.readyState);if(a.readyState!=
2)switch(c.readyState){case 2:try{var t=c.status}catch(E){return}if(t==200)try{d=window.setTimeout(n,Orbited.settings.HEARTBEAT_TIMEOUT)}catch(F){a.close();return}break;case 3:try{t=c.status}catch(p){return}if(t==200){q=50;k()}break;case 4:t=true;try{t=c.status===null?true:false}catch(u){}if(t){q*=2;window.clearTimeout(d);m=window.setTimeout(i,q);return}switch(c.status){case 200:k();e=0;setTimeout(h,0);window.clearTimeout(d);break;case 404:a.close();break;default:a.close();break}break}};c.send(null)}catch(v){a.close()}},
i=function(){a.logger.debug("reconnect...");if(c.readyState<4&&c.readyState>0){c.onreadystatechange=function(){c.readyState==4&&i()};a.logger.debug("do abort..");c.abort();window.clearTimeout(d)}else{a.logger.debug("reconnect do open");e=0;setTimeout(h,0)}},g=-1,l=null,j=[],k=function(){var r=c.responseText;for(o();r[e]==" ";)e+=1;for(;r[e]=="x";)e+=1;for(var v=0;1;){v+=1;if(v>2E3)throw new Error("Borked XHRStream transport");if(g==-1)g=r.indexOf(",",e);if(g==-1)return;if(l==null){argSize=parseInt(r.slice(e+
1,g));l=g+1+argSize}if(r.length<l)return;var t=r.slice(g+1,l);j.push(t);t=r.charAt(e)=="0";e=l;l=null;g=-1;if(t){t=j;j=[];s(t)}}},o=function(){window.clearTimeout(d);a.logger.debug("clearing heartbeatTimer",d);try{d=window.setTimeout(function(){a.logger.debug("timer",v,"did it");n()},Orbited.settings.HEARTBEAT_TIMEOUT)}catch(r){return}var v=d;a.logger.debug("heartbeatTimer is now",d)},n=function(){a.logger.debug("heartbeat timeout... reconnect");i()},s=function(r){var v=parseInt(r[0]);isNaN(v)||(f=
v);a.onread({id:v,name:r[1],data:r[2]})}};Orbited.CometTransports.XHRStream.prototype.logger=Orbited.getLogger("Orbited.CometTransports.XHRStream");Orbited.CometTransports.XHRStream.firefox=1;Orbited.CometTransports.XHRStream.firefox2=1;Orbited.CometTransports.XHRStream.firefox3=1;Orbited.CometTransports.XHRStream.safari2=1;Orbited.CometTransports.XHRStream.safari3=1;Orbited.CometTransports.LongPoll=function(){var a=this;a.name="longpoll";var b=null,c=null,f=null,e=50;a.readyState=0;a.onReadFrame=
function(){};a.onclose=function(){};a.close=function(){a.logger.debug("close");if(a.readyState!=2){if(c!=null&&(c.readyState>1||c.readyState<4)){c.onreadystatechange=function(){};c.abort();c=null}a.logger.debug("close! self.readyState now is 2");a.readyState=2;window.clearTimeout(null);a.onclose()}};a.connect=function(i){a.logger.debug("connect");if(a.readyState==1)throw new Error("Already Connected");b=new Orbited.URL(i);if(c==null)c=b.isSameDomain(location.href)?w():new Orbited.XSDR;b.path+="/longpoll";
a.readyState=1;d()};var d=function(){a.logger.debug("open... self.readyState = "+a.readyState);if(a.readyState!=2)try{typeof f=="number"&&b.setQsParameter("ack",f);if(typeof c=="undefined"||c==null)throw new Error("how did this happen?");if(Orbited.settings.enableFFPrivileges)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(i){}c.open("GET",b.render(),true);c.onreadystatechange=function(){a.logger.debug("readystate",c.readyState);switch(c.readyState){case 4:switch(c.status){case 200:a.timeoutResetter();
q();a.logger.debug("completed request, reconnect immediately");setTimeout(d,0);break;case 404:a.close();break;case null:e*=2;a.logger.debug("start reconnect Timer (null xhr.status)");window.setTimeout(m,e);break;default:a.logger.debug("something broke, xhr.status=",c.status);a.close();break}break}};c.send(null)}catch(g){a.close()}},m=function(){a.logger.debug("reconnect...");if(c.readyState<4&&c.readyState>0){c.onreadystatechange=function(){c.readyState==4&&m()};a.logger.debug("do abort..");c.abort();
window.clearTimeout(heartbeatTimer)}else{a.logger.debug("reconnect do open");offset=0;setTimeout(d,0)}},q=function(){a.logger.debug("process");for(var i=-1,g=null,l,j=[],k=c.responseText,o=0,n=0;1;){n+=1;if(n>2E3)throw new Error("Borked XHRStream transport");if(i==-1)i=k.indexOf(",",o);if(i==-1){a.logger.debug("no more commas. offset:",o,"stream.length:",k.length);return}if(g==null){l=parseInt(k.slice(o+1,i));g=i+1+l}a.logger.assert(true);i=k.slice(i+1,g);a.logger.assert(i.length==l,"argSize:",l,
"data.length",i.length);if(i.length!=l)DEBUGDATA=k;j.push(i);var s=k.charAt(o)=="0";o=g;g=null;i=-1;if(s){s=j;j=[];h(s)}}},h=function(i){var g=parseInt(i[0]);a.logger.debug("args",i);isNaN(g)||(f=g);a.logger.debug("testAckId",g,"ackId",f);a.onReadFrame({id:g,name:i[1],data:i[2]})}};Orbited.CometTransports.LongPoll.prototype.logger=Orbited.getLogger("Orbited.CometTransports.LongPoll");Orbited.CometTransports.Poll=function(){var a=this;a.name="poll";var b=null,c=null,f=null,e=Orbited.settings.POLL_INTERVAL,
d=e;a.readyState=0;a.onReadFrame=function(){};a.onclose=function(){};a.close=function(){a.logger.debug("close...");if(a.readyState!=2){if(c!=null&&(c.readyState>1||c.readyState<4)){c.onreadystatechange=function(){};c.abort();c=null}a.readyState=2;window.clearTimeout(null);a.onclose()}};a.connect=function(g){a.logger.debug("connect...");if(a.readyState==1)throw new Error("Already Connected");b=new Orbited.URL(g);if(c==null)c=b.isSameDomain(location.href)?w():new Orbited.XSDR;b.path+="/poll";a.readyState=
1;m()};var m=function(){a.logger.debug("open...");try{typeof f=="number"&&b.setQsParameter("ack",f);if(typeof c=="undefined"||c==null)throw new Error("how did this happen?");if(Orbited.settings.enableFFPrivileges)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(g){}c.open("GET",b.render(),true);c.onreadystatechange=function(){switch(c.readyState){case 4:switch(c.status){case 200:a.timeoutResetter();d=e;h();setTimeout(m,d);break;case 404:a.close();break;case null:d*=
2;window.setTimeout(q,d);break;default:a.close();break}break}};c.send(null)}catch(l){a.close()}},q=function(){a.logger.debug("reconnect...");if(c.readyState<4&&c.readyState>0){c.onreadystatechange=function(){c.readyState==4&&q()};a.logger.debug("do abort..");c.abort();window.clearTimeout(heartbeatTimer)}else{a.logger.debug("reconnect do open");offset=0;setTimeout(m,0)}},h=function(){a.logger.debug("process...");for(var g=-1,l=null,j,k=[],o=c.responseText,n=0,s=0;1;){s+=1;if(s>2E3)throw new Error("Borked XHRStream transport");
if(g==-1)g=o.indexOf(",",n);if(g==-1){a.logger.debug("no more commas. offset:",n,"stream.length:",o.length);return}if(l==null){j=parseInt(o.slice(n+1,g));l=g+1+j}g=o.slice(g+1,l);a.logger.assert(g.length==j,"argSize:",j,"data.length",g.length);if(g.length!=j)DEBUGDATA=o;k.push(g);var r=o.charAt(n)=="0";n=l;l=null;g=-1;if(r){r=k;k=[];i(r)}}},i=function(g){a.logger.debug("receivedPacket...");var l=parseInt(g[0]);a.logger.debug("args",g);isNaN(l)||(f=l);a.logger.debug("testAckId",l,"ackId",f);a.onReadFrame({id:l,
name:g[1],data:g[2]})}};Orbited.CometTransports.Poll.prototype.logger=Orbited.getLogger("Orbited.CometTransports.Poll");Orbited.CometTransports.HTMLFile=function(){var a=this;a.name="htmlfile";var b=++Orbited.singleton.HTMLFile.i;Orbited.singleton.HTMLFile.instances[b]=a;var c=null,f=null,e=null,d=null,m=null,q=2E3;a.onReadFrame=function(){};a.onread=function(g){a.onReadFrame(g)};a.onclose=function(){};a.connect=function(g){if(a.readyState==1)throw new Error("Already Connected");a.logger.debug("self.connect",
g);e=new Orbited.URL(g);e.path+="/htmlfile";e.setQsParameter("frameID",b.toString());a.readyState=1;h(e.render())};var h=function(g){a.logger.debug("doOpen",g);c=new ActiveXObject("htmlfile");c.open();a.isSubDomain?c.write('<html><script>document.domain="'+document.domain+'";<\/script></html>'):c.write("<html></html>");c.parentWindow.Orbited=Orbited;c.close();var l=c.createElement("div");c.body.appendChild(l);f=c.createElement("iframe");l.appendChild(f);d=f.src=g;m=window.setTimeout(i,q)};a.restartingStream=
function(g){d=g;m=window.setTimeout(i,q)};var i=function(){a.logger.debug("doing reconnect... "+q);q*=2;f.src=d;m=window.setTimeout(i,q)};a.streamStarted=function(){a.logger.debug("stream started..");window.clearTimeout(m);m=null;q=2E3};a.streamClosed=function(){a.logger.debug("stream closed!");window.clearTimeout(m);a.close()};a.receive=function(g,l,j){packet={id:g,name:l,data:j};a.onread(packet)};a.close=function(){if(a.readyState!=2){a.logger.debug("close called, clearing timer");window.clearTimeout(m);
a.readyState=2;f.src="about:blank";c=null;CollectGarbage();a.onclose()}}};Orbited.CometTransports.HTMLFile.prototype.logger=Orbited.getLogger("Orbited.CometTransports.HTMLFile");Orbited.CometTransports.HTMLFile.ie=1;Orbited.singleton.HTMLFile={i:0,instances:{}};Orbited.CometTransports.SSE=function(){var a=this;a.name="sse";a.onReadFrame=function(){};a.onclose=function(){};a.readyState=0;var b=null,c=null,f=-1;a.close=function(){if(a.readyState!=2){a.readyState=2;doClose();a.onclose()}};a.connect=
function(m){if(a.readyState==1)throw new Error("Already Connected");c=new Orbited.URL(m);c.path+="/sse";a.readyState=1;doOpen()};doClose=function(){b.removeEventSource(b.getAttribute("src"));b.setAttribute("src","");opera.version()<9.5&&document.body.removeChild(b);b=null};doOpen=function(){b=document.createElement("event-source");b.setAttribute("src",c.render());opera.version()<9.5&&document.body.appendChild(b);b.addEventListener("payload",e,false)};var e=function(m){m=eval(m.data);if(typeof m!=
"undefined")for(var q=0;q<m.length;++q){var h=m[q];d(h[0],h[1],h[2])}},d=function(m,q,h){var i=parseInt(m);isNaN(i)||(f=i);packet={id:m,name:q,data:h};a.onReadFrame(packet)}};Orbited.CometTransports.SSE.prototype.logger=Orbited.getLogger("Orbited.CometTransports.SSE");Orbited.CometTransports.SSE.opera=1;Orbited.CometTransports.SSE.opera8=1;Orbited.CometTransports.SSE.opera9=1;Orbited.CometTransports.SSE.opera9_5=0.8;Orbited.URL=function(a){var b=this,c=a.indexOf("://");if(c!=-1)b.protocol=a.slice(0,
c);else c=-3;var f=a.indexOf("/",c+3);if(f==-1)f=a.length;var e=a.indexOf("#",f);if(e!=-1)b.hash=a.slice(e+1);else e=a.length;e=a.slice(f,e);var d=e.indexOf("?");if(d==-1)d=e.length;b.path=e.slice(0,d);b.qs=e.slice(d+1);if(b.path=="")b.path="/";c=a.slice(c+3,f);f=c.indexOf(":");if(f==-1){b.port=80;f=c.length}else b.port=parseInt(c.slice(f+1));if(isNaN(this.port))throw new Error("Invalid _url");b.domain=c.slice(0,f);b.render=function(){var h="";if(typeof b.protocol!="undefined")h+=b.protocol+"://";
h+=b.domain;if(b.port!=80&&typeof b.port!="undefined"&&b.port!=null)if(typeof b.port!="string"||b.port.length>0)h+=":"+b.port;h+=typeof b.path=="undefined"||b.path==null?"/":b.path;if(b.qs.length>0)h+="?"+b.qs;if(typeof b.hash!="undefined"&&b.hash.length>0)h+="#"+b.hash;return h};b.isSamePort=function(h){h=new Orbited.URL(h);return h.port==b.port};b.isSameDomain=function(h){h=new Orbited.URL(h);if(!h.domain||!b.domain)return true;return h.port==b.port&&h.domain==b.domain};b.isSameParentDomain=function(h){h=
new Orbited.URL(h);if(h.domain==b.domain)return true;for(var i=h.domain,g=document.domain.split("."),l=0;l<g.length-1;++l){var j=g.slice(l).join(".");if(i==j)return true}return false};b.isSubDomain=function(h){h=new Orbited.URL(h);if(!h.domain||!b.domain)return false;return h.port==b.port&&b.domain.indexOf("."+h.domain)>0};var m=function(h){if(h.indexOf("=")==-1)return{};var i={};h=h.split("&");for(var g=0;g<h.length;++g){var l=h[g].split("=");i[l[0]]=l[1]}return i},q=function(h){var i="";for(var g in h)i+=
"&"+g+"="+h[g];return i.slice(1)};b.setQsParameter=function(h,i){var g=m(b.qs);g[h]=i;b.qs=q(g)};b.mergeQs=function(h){h=m(h);for(key in h)curQsObj[key]=h[key]};b.removeQsParameter=function(h){var i=m(b.qs);delete i[h];b.qs=q(i)};b.merge=function(h){if(typeof b.protocol!="undefined"&&b.protocol.length>0)b.protocol=h.protocol;if(h.domain.length>0){b.domain=h.domain;b.port=h.port}b.path=h.path;b.qs=h.qs;b.hash=h.hash}};Orbited.utf8={};Orbited.utf8.decode=function(a){function b(d){for(;d.length<6;)d=
"0"+d;return d}for(var c=[],f=0,e=0;e<a.length;e++)if((a.charCodeAt(e)&248)==240){if(a.length-f<4)break;f+=4;c.push(String.fromCharCode(parseInt((a.charCodeAt(e)&7).toString(2)+b((a.charCodeAt(e+1)&63).toString(2))+b((a.charCodeAt(e+2)&63).toString(2))+b((a.charCodeAt(e+3)&63).toString(2)),2)));e+=3}else if((a.charCodeAt(e)&240)==224){if(a.length-f<3)break;f+=3;c.push(String.fromCharCode(parseInt((a.charCodeAt(e)&15).toString(2)+b((a.charCodeAt(e+1)&63).toString(2))+b((a.charCodeAt(e+2)&63).toString(2)),
2)));e+=2}else if((a.charCodeAt(e)&224)==192){if(a.length-f<2)break;f+=2;c.push(String.fromCharCode(parseInt((a.charCodeAt(e)&31).toString(2)+b((a.charCodeAt(e+1)&63).toString(2),6),2)));e+=1}else{f+=1;c.push(String.fromCharCode(a.charCodeAt(e)))}return[c.join(""),f]};Orbited.utf8.encode=function(a){function b(m,q){for(;m.length<q;)m="0"+m;return m}for(var c=[],f=String.fromCharCode,e=0;e<a.length;e++){var d=a.charCodeAt(e);if(d<=127)c.push(f(d));else if(d<=2047){d=b(d.toString(2),11);c.push(f(parseInt("110"+
d.substr(0,5),2)));c.push(f(parseInt("10"+d.substr(5,6),2)))}else if(d<=65535){d=b(d.toString(2),16);c.push(f(parseInt("1110"+d.substr(0,4),2)));c.push(f(parseInt("10"+d.substr(4,6),2)));c.push(f(parseInt("10"+d.substr(10,6),2)))}else if(d<=1114111){d=b(d.toString(2),21);c.push(f(parseInt("11110"+d.substr(0,3),2)));c.push(f(parseInt("10"+d.substr(3,6),2)));c.push(f(parseInt("10"+d.substr(9,6),2)));c.push(f(parseInt("10"+d.substr(15,6),2)))}}return c.join("")};Orbited.JSON=function(){function a(i){return i<
10?"0"+i:i}function b(i){e.lastIndex=0;return e.test(i)?'"'+i.replace(e,function(g){var l=q[g];if(typeof l==="string")return l;return"\\u"+("0000"+(+g.charCodeAt(0)).toString(16)).slice(-4)})+'"':'"'+i+'"'}function c(i,g){var l,j,k=d,o,n=g[i];if(n&&typeof n==="object"&&typeof n.toJSON==="function")n=n.toJSON(i);if(typeof h==="function")n=h.call(g,i,n);switch(typeof n){case "string":return b(n);case "number":return isFinite(n)?String(n):"null";case "boolean":case "null":return String(n);case "object":if(!n)return"null";
d+=m;o=[];if(typeof n.length==="number"&&!n.propertyIsEnumerable("length")){j=n.length;for(i=0;i<j;i+=1)o[i]=c(i,n)||"null";g=o.length===0?"[]":d?"[\n"+d+o.join(",\n"+d)+"\n"+k+"]":"["+o.join(",")+"]";d=k;return g}if(h&&typeof h==="object"){j=h.length;for(i=0;i<j;i+=1){l=h[i];if(typeof l==="string")if(g=c(l,n))o.push(b(l)+(d?": ":":")+g)}}else for(l in n)if(Object.hasOwnProperty.call(n,l))if(g=c(l,n))o.push(b(l)+(d?": ":":")+g);g=o.length===0?"{}":d?"{\n"+d+o.join(",\n"+d)+"\n"+k+"}":"{"+o.join(",")+
"}";d=k;return g}}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var f=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d,m,q={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},h;return{stringify:function(i,g,l){var j;m=d="";if(typeof l==="number")for(j=0;j<l;j+=1)m+=" ";else if(typeof l==="string")m=l;if((h=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw new Error("JSON.stringify");return c("",{"":i})},parse:function(i,g){function l(j,k){var o,n,s=j[k];if(s&&typeof s==="object")for(o in s)if(Object.hasOwnProperty.call(s,o)){n=l(s,o);if(n!==undefined)s[o]=
n;else delete s[o]}return g.call(j,k,s)}f.lastIndex=0;if(f.test(i))i=i.replace(f,function(j){return"\\u"+("0000"+(+j.charCodeAt(0)).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(i.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){i=eval("("+i+")");return typeof g==="function"?l({"":i},""):i}throw new SyntaxError("JSON.parse");}}}()})();
(function(){try{for(var w=document.getElementsByTagName("script"),A=0;A<w.length;++A){var y=w[A];if(y.src.match("/static/Orbited.js$")){var z=new Orbited.URL(y.src);if(z.render().indexOf("http")!=0)z=new Orbited.URL(window.location.toString());Orbited.settings.hostname=z.domain;Orbited.settings.port=z.port;break}}}catch(a){}})();
