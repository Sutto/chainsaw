var Chainsaw={Util:{},spinderella:null,processors:{},loadExisting:true,streamURL:"",callbackCount:0,onReadyCallbacks:[],connected:false,host:"",ports:{base:42340,websocket:42342},debug:false,loadJSONP:function(a,b){var c=this.callbackCount++,e="chainsaw-callback-"+c,f="jsonpCallback"+c;Chainsaw[f]=function(d){typeof b=="function"&&b(d);delete Chainsaw[f];if(d=document.getElementById(e)){d.parentElement.removeChild(d);for(var g in d)delete d[g]}};c="Chainsaw."+f;a=a.indexOf("?")<0?a+"?callback="+c:
a.replace("=?","="+c);Chainsaw.log("Real URL is "+a);c=document.createElement("script");c.type="text/javascript";c.id=e;c.src=a;document.getElementsByTagName("head")[0].appendChild(c)},urlForStream:function(a,b){var c=this.streamURL.replace("IDENTIFIER",a);if(b)c+=b;Chainsaw.log("Got url for",a,"-",c);return c},subscribe:function(a){this.spinderella.client.subscribe(["chainsaw/"+a])},watch:function(a,b){Chainsaw.log("Calling watch with stream =",a,"and loadExisting =",b);if(b!==false&&b!==true)b=
this.loadExisting;var c=this,e=function(){c.subscribe(a)};Chainsaw.log("Watching",a,"and load existing is",b);b?this.loadJSONP(this.urlForStream(a),function(f){for(var d=f.length;d>0;d--)Chainsaw.receiveFromStream(f[d-1],a);e()}):e()},watchAll:function(){for(var a=arguments.length,b=0;b<a;b++)this.watch(arguments[b])},onMessage:function(a,b){if(typeof b=="function")this.processors[a]=b},onReady:function(a){typeof a=="function"&&this.onReadyCallbacks.push(a)},ready:function(){Chainsaw.log("Invoking the onReady callbacks");
for(var a=this.onReadyCallbacks.length,b=0;b<a;b++)this.onReadyCallbacks[b]();this.onReadyCallbacks=[]},alias:function(a,b){this.onMessage(b,function(c,e){Chainsaw.processors[a](msg,e)})},init:function(a,b){if(this.spinderella==null){if(!a)a=this.host;if(b===undefined||b===null)b=this.ports;this.spinderella=Spinderella.create(a,b);var c=this;this.spinderella.onMessage(function(){c.receiveMessage.apply(c,arguments)})}},connect:function(a){if(!this.connected){Chainsaw.log("Adding onready callback");
this.onReady(a);Chainsaw.log("Calling init()");this.init();Chainsaw.log("Preparing to start spinderella connection.");this.spinderella.connect(function(){Chainsaw.log("Spinderella Connected!");Chainsaw.connected=true;Chainsaw.ready()})}},receiveMessage:function(a,b,c){switch(b){case "channel":this.receiveFromStream(JSON.parse(a),c.channel.replace(/^chainsaw\//,""));break;default:eval(a);break}},receiveFromStream:function(a,b){var c=this.processors[b];if(c)with(this.Util)c(a,b)},log:function(){if(!(!Chainsaw.debug||
console==undefined||console.log==undefined)){var a=["[CHAINSAW]"].concat(Array.prototype.slice.apply(arguments));console.log.apply(console,a)}}};Spinderella.log=Chainsaw.log;
